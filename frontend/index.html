<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inventory Management System (SPA Simulation)</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.7);
        padding-top: 60px;
      }
      .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        animation-name: animatetop;
        animation-duration: 0.4s;
      }
      .modal-content label {
        display: block;
        margin-top: 10px;
        font-weight: 600;
      }
      .modal-content input[type="text"],
      .modal-content input[type="number"] {
        width: 95%;
        padding: 10px;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .modal-content button {
        margin-top: 20px;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
      }
      .modal-content .close-btn {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }
      .modal-content .close-btn:hover,
      .modal-content .close-btn:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
      }
      @keyframes animatetop {
        from {
          top: -300px;
          opacity: 0;
        }
        to {
          top: 0;
          opacity: 1;
        }
      }
      .delete-list {
        list-style: none;
        padding: 0;
      }
      .delete-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
      }
      .delete-list button {
        background-color: #dc3545;
        color: white;
        border-radius: 4px;
        padding: 5px 10px;
        cursor: pointer;
      }
      .delete-list span {
        flex-basis: 30%;
      }
      .delete-list strong {
        flex-basis: 40%;
      }
      .pattern-context {
        border-left: 5px solid #28a745;
        padding: 10px;
        margin-bottom: 20px;
        background-color: #f0fff0;
      }
      .pattern-context strong {
        color: #28a745;
      }
    </style>
  </head>
  <body onload="loadPage('home')">
    <header>
      <h1>Inventory Management System (SPA Simulation)</h1>
      <p>Developed with Design Patterns</p>
    </header>

    <div class="container">
      <aside class="menu">
        <h2>‚öôÔ∏è Operation Menu</h2>
        <p class="explanation">
          Your selections simulate Backend (Java Console) operations. Logs are
          below.
        </p>
        <div id="backend-output">
          <p class="info-message">System Ready. Please select an operation.</p>
        </div>

        <button onclick="loadPage('add_category')">1. Add New Category</button>
        <button onclick="loadPage('add_product')">
          2. Add New Product (Builder)
        </button>
        <button onclick="loadPage('update_product_select')">
          3. Update Product/Stock/Price
        </button>
        <button onclick="loadPage('home')">4. View Full Catalog</button>
        <button onclick="loadPage('settings')">
          5. Settings (Strategy/Singleton)
        </button>
        <button onclick="loadPage('delete_product')">7. Delete Product</button>
        <button onclick="loadPage('delete_category')">
          8. Delete Category
        </button>
        <button onclick="handleSimpleAction(9, 'Exit')">9. Exit</button>
      </aside>

      <main class="catalog" id="content-container">
        <p>Page loading...</p>
      </main>
    </div>

    <footer>
      <p>&copy; 2024 Design Patterns Project | 6 Patterns Integrated.</p>
    </footer>

    <script>
      const output = document.getElementById("backend-output");

      function log(message, type = "info") {
        const p = document.createElement("p");
        p.className = `log-${type}`;
        p.innerHTML = `${new Date().toLocaleTimeString()} &gt; ${message}`;
        output.prepend(p);
      }

      let stockThreshold = 5;
      let nextProductId = 6;

      const DEFAULT_STATE = {
        ELECTRONICS: {
          COMPUTERS: {
            LAPTOPS: [
              {
                id: 1,
                name: "Gamer Pro X (i9/32GB)",
                basePrice: 1499.99,
                finalPrice: 1199.99,
                stock: 4,
                isDecorated: true,
                categoryPath: "ELECTRONICS.COMPUTERS.LAPTOPS",
              },
              {
                id: 2,
                name: "Business Ultra",
                basePrice: 999.99,
                finalPrice: 999.99,
                stock: 8,
                isDecorated: false,
                categoryPath: "ELECTRONICS.COMPUTERS.LAPTOPS",
              },
            ],
            DESKTOPS: [],
          },
          PHONES: [
            {
              id: 3,
              name: "Smartphone",
              basePrice: 799.99,
              finalPrice: 879.99,
              stock: 15,
              isDecorated: true,
              categoryPath: "ELECTRONICS.PHONES",
            },
            {
              id: 4,
              name: "Basic Phone",
              basePrice: 99.99,
              finalPrice: 99.99,
              stock: 20,
              isDecorated: false,
              categoryPath: "ELECTRONICS.PHONES",
            },
          ],
        },
        CLOTHING: [
          {
            id: 5,
            name: "T-Shirt",
            basePrice: 29.99,
            finalPrice: 29.99,
            stock: 50,
            isDecorated: false,
            categoryPath: "CLOTHING",
          },
        ],
      };

      let inventoryState = {};

      function saveState() {
        try {
          localStorage.setItem(
            "inventoryState",
            JSON.stringify(inventoryState)
          );
          localStorage.setItem("stockThreshold", stockThreshold);
          localStorage.setItem("nextProductId", nextProductId);
        } catch (e) {
          console.error("Error saving state to localStorage:", e);
        }
      }

      function loadPersistentState() {
        try {
          const storedState = localStorage.getItem("inventoryState");
          const storedThreshold = localStorage.getItem("stockThreshold");
          const storedNextId = localStorage.getItem("nextProductId");

          if (storedState) {
            inventoryState = JSON.parse(storedState);
            stockThreshold = storedThreshold ? parseInt(storedThreshold) : 5;
            nextProductId = storedNextId ? parseInt(storedNextId) : 6;
            log("üíæ State loaded successfully from LocalStorage.", "success");
          } else {
            inventoryState = JSON.parse(JSON.stringify(DEFAULT_STATE));
            log("üíæ Loaded default initial state.", "info");
          }
        } catch (e) {
          console.error("Error loading state from localStorage:", e);
          inventoryState = JSON.parse(JSON.stringify(DEFAULT_STATE));
        }
      }

      loadPersistentState();

      function getAllProducts() {
        const products = [];

        function traverse(obj) {
          if (Array.isArray(obj)) {
            products.push(...obj);
          } else if (typeof obj === "object" && obj !== null) {
            for (const key in obj) {
              traverse(obj[key]);
            }
          }
        }
        traverse(inventoryState);
        return products;
      }

      function findProductById(id) {
        const allProducts = getAllProducts();
        const targetId = parseInt(id);

        return allProducts.find((p) => p.id === targetId);
      }

      function loadPage(pageName) {
        const container = document.getElementById("content-container");
        container.innerHTML = "<h2>Loading Page...</h2>";

        let fileName = pageName;
        if (pageName.startsWith("update_product_form")) {
          fileName = "update_product_form";
        }

        fetch(`pages/${fileName}.html`)
          .then((response) => {
            if (!response.ok) {
              throw new Error("Page not found: " + response.statusText);
            }
            return response.text();
          })
          .then((html) => {
            container.innerHTML = html;
            log(`üñºÔ∏è Page loaded: ${pageName}`, "info");

            if (pageName === "home") {
              renderCatalog();
            }
            if (pageName === "settings") {
              document.getElementById("current-threshold-settings").innerText =
                stockThreshold;
            }
            if (pageName === "delete_product") {
              renderDeleteList();
            }
            if (pageName === "delete_category") {
              renderDeleteCategoryList();
            }
            if (pageName === "update_product_select") {
              renderUpdateSelectList();
            }

            if (pageName.startsWith("update_product_form")) {
              const id = parseInt(pageName.split("-").pop());
              const targetProduct = findProductById(id);
              if (targetProduct) {
                document.getElementById(
                  "target-product-name"
                ).innerText = `${targetProduct.name}`;
                document.getElementById("stock-threshold-display").innerText =
                  stockThreshold;
                document.getElementById("product-id-hidden").value = id;
              }
            }
          })
          .catch((error) => {
            container.innerHTML = `<h2 style="color:red;">Error: ${error.message}</h2>`;
            log(
              `‚ùå Page Loading Error: Failed to fetch (${error.message})`,
              "error"
            );
          });
      }

      function handleSimpleAction(choice, actionName) {
        log(`‚û°Ô∏è Selected Operation: ${actionName}`, "action");
        if (choice === 9) {
          log(
            "System shutting down. Goodbye! (Refresh browser to reset state) üëã",
            "exit"
          );
        }
      }

      function renderProductList(products) {
        if (!Array.isArray(products) || products.length === 0) {
          return "";
        }
        let listHTML = '<ul class="product-list">';
        products.forEach((prod) => {
          const tag = prod.isDecorated ? "DECORATED" : "NORMAL PRICING";
          const stockClass =
            prod.stock <= stockThreshold ? "stock low" : "stock";

          listHTML += `
                    <li class="product">
                        <strong>${prod.name}</strong> 
                        <span class="tag decorated">${tag}</span>
                        <span class="price">$${prod.finalPrice.toFixed(
                          2
                        )}</span>
                        <span class="${stockClass}" data-stock="${
            prod.stock
          }">Stock: ${prod.stock}</span>
                    </li>
                `;
        });
        listHTML += "</ul>";
        return listHTML;
      }

      function renderCatalog() {
        const container = document.getElementById("content-container");
        let catalogHTML = `
                <div class="pattern-context">
                    <strong>Pattern: Composite (Structural)</strong>
                    <p>The catalog structure below is dynamically generated from the JavaScript state, demonstrating how the Composite pattern builds a hierarchical tree of Categories (Composite Nodes) and Products (Leaf Nodes).</p>
                </div>
                <h2>üì¶ Product Catalog (Composite Hierarchy)</h2>
                <p class="last-update">Singleton Threshold: <strong id="current-threshold-home">${stockThreshold}</strong> | Data Managed by State (LocalStorage).</p>
                <div id="category-tree">
            `;

        for (const catName in inventoryState) {
          const categoryData = inventoryState[catName];

          catalogHTML += `<section class="category" style="margin-top: 20px; border-left-color: ${
            catName === "ELECTRONICS" ? "#007bff" : "#f0ad4e"
          };">
                                    <h3 style="color:${
                                      catName === "ELECTRONICS"
                                        ? "#007bff"
                                        : "#f0ad4e"
                                    };">+ ${catName}</h3>`;

          if (
            typeof categoryData === "object" &&
            !Array.isArray(categoryData)
          ) {
            for (const subCatName in categoryData) {
              const subCategoryData = categoryData[subCatName];

              catalogHTML += `<div class="subcategory">
                                            <h4 style="color:#5aa5ff;">+ ${subCatName}</h4>`;

              if (
                typeof subCategoryData === "object" &&
                !Array.isArray(subCategoryData)
              ) {
                for (const productKey in subCategoryData) {
                  const productList = subCategoryData[productKey];

                  catalogHTML += `<div class="sub-subcategory">
                                                    <h5 style="color:#777;">+ ${productKey}</h5>
                                                    ${renderProductList(
                                                      productList
                                                    )}
                                                </div>`;
                }
              } else {
                catalogHTML += renderProductList(subCategoryData);
              }

              catalogHTML += `</div>`;
            }
          } else if (Array.isArray(categoryData)) {
            catalogHTML += renderProductList(categoryData);
          }
          catalogHTML += `</section>`;
        }
        catalogHTML += `</div>`;
        container.innerHTML = catalogHTML;
        log("‚úÖ Catalog dynamically rebuilt from State.", "success");
      }

      function renderDeleteList() {
        const listContainer = document.getElementById("delete-product-list");
        const allProducts = getAllProducts();
        if (!listContainer) return;

        let listHTML = "";
        if (allProducts.length === 0) {
          listHTML = "<p>No products available in the inventory.</p>";
        } else {
          allProducts.forEach((prod) => {
            listHTML += `
                         <li id="prod-${prod.id}">
                            <span>ID: ${prod.id}</span>
                            <strong>${prod.name}</strong> 
                            <span>Category: ${prod.categoryPath
                              .split(".")
                              .pop()}</span>
                            <button onclick="simulateDeleteProduct(${
                              prod.id
                            }, '${prod.name}')">DELETE</button>
                         </li>
                     `;
          });
          listHTML = `<ul class="delete-list">${listHTML}</ul>`;
        }
        listContainer.innerHTML = listHTML;
      }

      function renderDeleteCategoryList() {
        const listContainer = document.getElementById("delete-category-list");
        if (!listContainer) return;

        let listHTML = '<ul>';

        function traverseAndAddCategories(node, currentPath = "") {
            for (const key in node) {
                const categoryContent = node[key];
                const newPath = currentPath ? `${currentPath}.${key}` : key;
                
                if (typeof categoryContent === "object" && categoryContent !== null && !Array.isArray(categoryContent)) {
                    const level = currentPath.split('.').length;
                    const indent = level > 1 ? "‚Äî".repeat(level - 1) + " " : "";

                    listHTML += `
                        <li class="delete-list-item">
                            <strong>${indent}üì¶ ${key}</strong> 
                            <span>Path: ${newPath} (Composite Node)</span>
                            <button onclick="simulateDeleteCategory('${newPath}')">DELETE</button>
                        </li>
                    `;
                    traverseAndAddCategories(categoryContent, newPath);

                } else if (Array.isArray(categoryContent)) {
                    const level = currentPath.split('.').length + 1;
                    const indent = "‚Äî".repeat(level - 1) + " ";
                    
                    listHTML += `
                        <li class="delete-list-item">
                            <strong>${indent}üìÑ ${key}</strong> 
                            <span>Path: ${newPath} (Leaf Node/Products)</span>
                            <button onclick="simulateDeleteCategory('${newPath}')">DELETE</button>
                        </li>
                    `;
                }
            }
        }

        traverseAndAddCategories(inventoryState);
        listHTML += '</ul>';
        
        if (listHTML === '<ul></ul>') {
             listContainer.innerHTML = "<p>No categories available to delete in the inventory.</p>";
        } else {
            listContainer.innerHTML = `<ul class="delete-list">${listHTML}</ul>`;
        }
      }

      function renderUpdateSelectList() {
        const listContainer = document.getElementById(
          "update-product-select-list"
        );
        const allProducts = getAllProducts();

        if (!listContainer) return;

        let listHTML = "";
        allProducts.forEach((prod) => {
          listHTML += `
                     <li>
                        <strong>${prod.name}</strong> 
                        <span>Category: ${prod.categoryPath
                          .split(".")
                          .pop()}</span>
                        <button onclick="loadPage('update_product_form-${
                          prod.id
                        }')">Select</button>
                     </li>
                 `;
        });
        listContainer.innerHTML = `<ul class="delete-list">${listHTML}</ul>`;
      }

      function simulateDeleteProduct(id, name) {
        let found = false;
        function deleteFromList(obj) {
          if (Array.isArray(obj)) {
            const initialLength = obj.length;
            const filtered = obj.filter((prod) => prod.id !== id);
            if (filtered.length < initialLength) {
              obj.splice(0, initialLength, ...filtered);
              found = true;
            }
          } else if (typeof obj === "object") {
            for (const key in obj) {
              deleteFromList(obj[key]);
              if (found) return;
            }
          }
        }

        deleteFromList(inventoryState);

        if (found) {
          saveState();
          log(
            `‚úÖ Product "${name}" (ID: ${id}) deleted from state.`,
            "success"
          );
        } else {
          log(`‚ùå Error: Product ${name} not found.`, "error");
        }
        loadPage("delete_product");
      }

      function simulateDeleteCategory(path) {
        if (
          confirm(
            `Are you sure you want to delete the category: ${path}? This will delete all contained products/subcategories in the simulation.`
          )
        ) {
          const pathSegments = path.split('.');
          let current = inventoryState;
          let parent = null;
          let finalKey = null;

          for (let i = 0; i < pathSegments.length; i++) {
              const key = pathSegments[i];
              if (!current[key]) {
                  log(`‚ùå Error: Category path "${path}" not found.`, "error");
                  return;
              }
              parent = current;
              finalKey = key;
              current = current[key];
          }

          if (parent && finalKey) {
              delete parent[finalKey];
              saveState();
              log(`üóëÔ∏è Category "${path}" deleted from state.`, "success");
          } else {
              log(`‚ùå Error: Deletion failed for category "${path}".`, "error");
          }

          loadPage("delete_category");
        }
      }

      function simulateUpdateProduct(id, pattern) {
        const targetProduct = findProductById(id);

        if (!targetProduct) {
          log("‚ùå Error: Target product not found.", "error");
          return;
        }

        if (pattern === "Decorator") {
          targetProduct.finalPrice = targetProduct.basePrice * 0.8;
          targetProduct.isDecorated = true;
          log(
            `üéÅ Decorator (Discount) applied to ${
              targetProduct.name
            }. New Price: $${targetProduct.finalPrice.toFixed(2)}`,
            "success"
          );
        } else if (pattern === "Observer") {
          const newStockStr = prompt(
            `Enter new stock quantity for ${targetProduct.name} (Current: ${targetProduct.stock}):`
          );
          const newStock = parseInt(newStockStr);
          if (isNaN(newStock)) {
            log("‚ùå Error: Please enter a valid stock value.", "error");
            return;
          }
          targetProduct.stock = newStock;
          if (newStock <= stockThreshold) {
            log(
              `‚ö†Ô∏è LOW STOCK ALERT: Stock fell below threshold (${stockThreshold})!`,
              "error"
            );
          }
        }
        saveState();
        loadPage("home");
      }

      function simulateUpdateThreshold() {
        const newThreshold = parseInt(
          document.getElementById("new-threshold").value
        );
        if (isNaN(newThreshold) || newThreshold < 0) {
          log("‚ùå Error: Please enter a valid stock threshold.", "error");
          return;
        }
        stockThreshold = newThreshold;
        saveState();
        loadPage("home");
      }

      function simulateStrategy(type) {
        const taxRate = 1.18;
        const traverseState = (obj) => {
          for (const key in obj) {
            if (Array.isArray(obj[key])) {
              obj[key].forEach((prod) => {
                if (type === "TaxIncluded") {
                  prod.finalPrice = prod.basePrice * taxRate;
                } else {
                  prod.finalPrice = prod.basePrice;
                }
              });
            } else if (typeof obj[key] === "object") {
              traverseState(obj[key]);
            }
          }
        };
        traverseState(inventoryState);
        saveState();
        loadPage("home");
      }

      window.log = log;
      window.loadPage = loadPage;
      window.stockThreshold = stockThreshold;
      window.inventoryState = inventoryState;
      window.simulateUpdateThreshold = simulateUpdateThreshold;
      window.simulateStrategy = simulateStrategy;
      window.renderCatalog = renderCatalog;
      window.simulateDeleteProduct = simulateDeleteProduct;
      window.renderDeleteList = renderDeleteList;
      window.renderDeleteCategoryList = renderDeleteCategoryList;
      window.renderUpdateSelectList = renderUpdateSelectList;
      window.simulateDeleteCategory = simulateDeleteCategory;
      window.findProductById = findProductById;
      window.getAllProducts = getAllProducts;

      window.onclick = function (event) {
        if (event.target.classList.contains("modal")) {
          event.target.style.display = "none";
        }
      };
    </script>
    <script src="add_product.js"></script>
    <script src="add_category.js"></script>
  </body>
</html>